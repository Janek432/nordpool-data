name: Update Nord Pool Prices

on:
  schedule:
    - cron: '1 0 * * *'   # UTC 00:01 â†’ Eesti 02:01 suvel / 01:01 talvel
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests python-dateutil

      - name: Download Nord Pool data with validation + retry
        run: |
          python3 << 'EOF'
          import json, time
          import requests
          from datetime import datetime

          url = "https://dashboard.elering.ee/api/nps/price"

          # kuupÃ¤ev tÃ¤naseks (UTC)
          today = datetime.utcnow().strftime("%Y-%m-%d")
          start = f"{today}T00:00:00Z"
          end   = f"{today}T23:59:59Z"

          print("â³ Starting Nordpool fetch sequence...")
          print(f"   Querying: {start} â†’ {end}")

          MAX_RETRIES = 6
          RETRY_DELAY = 300  # 5 min
          data = None

          for attempt in range(1, MAX_RETRIES+1):
              print(f"\nðŸ”Ž Attempt {attempt}/{MAX_RETRIES}")
              try:
                  resp = requests.get(f"{url}?start={start}&end={end}", timeout=10)
                  print("HTTP:", resp.status_code)

                  if resp.status_code != 200:
                      raise RuntimeError("HTTP fail")

                  payload = resp.json()

                  # Kontroll: kas struktuur olemas
                  if "data" not in payload or "ee" not in payload["data"]:
                      raise ValueError("JSON missing structure")

                  ee_list = payload["data"]["ee"]
                  print(f"Found {len(ee_list)} EE price entries")

                  # Peamine kontroll â€” peab olema 96 Ã— 15min kirjet
                  if len(ee_list) == 96:
                      print("âœ… Data OK â€” 96 entries complete!")
                      data = payload
                      break
                  else:
                      print("âŒ Data incomplete. Expected 96 entries.")

              except Exception as e:
                  print("ERROR:", e)

              if attempt < MAX_RETRIES:
                  print(f"â± Waiting {RETRY_DELAY} sec before retry...")
                  time.sleep(RETRY_DELAY)

          if data is None:
              print("âŒ FAILED: Could not fetch complete dataset. Aborting.")
              exit(1)

          # SALVESTA TÃ„IS JSON
          with open("data/today_prices.json", "w") as f:
              json.dump(data, f, indent=2)

          # SALVESTA AINULT EE
          with open("data/ee_today.json", "w") as f:
              json.dump(data["data"]["ee"], f, indent=2)

          print("\nðŸŽ‰ SUCCESS â€” Files updated!")
          EOF

      - name: Commit and push
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data/today_prices.json data/ee_today.json
          git commit -m "Daily Nordpool update" || echo "No changes to commit"

          git push https://x-access-token:$GH_PAT@github.com/Janek432/nordpool-data.git HEAD:main
